# Water Monitoring System ğŸ’§

Sistema de monitoreo de consumo de agua con visualizaciÃ³n en mapa interactivo, estadÃ­sticas y gestiÃ³n de contadores. **Integrado con sistema de detecciÃ³n automÃ¡tica de lecturas mediante IA (YOLO)**.

## ğŸŒŸ CaracterÃ­sticas

- **ğŸ¤– IntegraciÃ³n con IA**: Recibe lecturas automÃ¡ticas desde `water-meter-detection` mediante el endpoint `/api/public/reading/`
- **ğŸ—ºï¸ Dashboard Interactivo**: Mapa con visualizaciÃ³n en tiempo real de contadores (Leaflet + PostGIS)
- **ğŸ“Š AnÃ¡lisis de Consumo**: GrÃ¡ficas interactivas, estadÃ­sticas y detecciÃ³n de picos
- **âš™ï¸ GestiÃ³n Completa**: CRUD de modelos de contadores y contadores individuales
- **ğŸ“¤ ImportaciÃ³n CSV**: Carga masiva de datos histÃ³ricos
- **ğŸ”Œ API REST Completa**: Django REST Framework con endpoints pÃºblicos y autenticados

---

## ğŸ”§ TecnologÃ­as

- **Backend**: Django 4.0+, Django REST Framework
- **Base de datos**: PostgreSQL + PostGIS (datos geoespaciales)
- **ConfiguraciÃ³n**: python-decouple (variables de entorno)
- **Frontend**: Tailwind CSS, Alpine.js, Leaflet (mapas), Chart.js (grÃ¡ficas)
- **IntegraciÃ³n**: Recibe lecturas automÃ¡ticas desde el modelo YOLO

---

## ğŸ“‹ Requisitos Previos

- Python 3.8+
- PostgreSQL 12+ con extensiÃ³n PostGIS
- GDAL (para GeoDjango)

### Instalar dependencias del sistema

**Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install -y python3-pip python3-venv postgresql postgresql-contrib postgis gdal-bin libgdal-dev
```

**macOS:**
```bash
brew install postgresql postgis gdal
```

---

## ğŸš€ InstalaciÃ³n

### Linux/macOS (con script automÃ¡tico)

```bash
cd water_monitoring
chmod +x setup.sh
./setup.sh
```

El script realizarÃ¡ automÃ¡ticamente:
- CreaciÃ³n del entorno virtual
- InstalaciÃ³n de dependencias
- ConfiguraciÃ³n de la base de datos
- CreaciÃ³n del superusuario

### Windows (PowerShell)

1. **Crear entorno virtual e instalar dependencias:**

```powershell
cd water_monitoring
python -m venv venv
.\venv\Scripts\Activate.ps1
pip install --upgrade pip
pip install -r requirements.txt
```

2. **Configurar variables de entorno (`.env`):**

Crea un archivo `.env` en la raÃ­z del proyecto:

```env
SECRET_KEY=tu_secret_key_aqui
DEBUG=True
DB_NAME=water_monitoring_db
DB_USER=postgres
DB_PASSWORD=postgres
DB_HOST=127.0.0.1
DB_PORT=5432
ADMIN_USERNAME=admin
ADMIN_EMAIL=admin@example.com
ADMIN_PASSWORD=admin123
```

3. **Preparar la base de datos:**

```powershell
python manage.py makemigrations
python manage.py migrate
python manage.py create_admin
```

4. **Ejecutar el servidor:**

```powershell
python manage.py runserver
```

---

## ğŸ“ Acceso a la AplicaciÃ³n

- **Dashboard**: http://127.0.0.1:8000/
- **Panel de administraciÃ³n SPA**: http://127.0.0.1:8000/admin-panel/
- **Django Admin clÃ¡sico**: http://127.0.0.1:8000/admin/

---

## ğŸ”Œ API Endpoints

### ğŸ¤– **IntegraciÃ³n con IA (water-meter-detection)**

#### **POST** `/api/public/reading/` 
**âœ¨ Endpoint principal para recibir lecturas desde el modelo YOLO**

Este endpoint recibe las lecturas detectadas automÃ¡ticamente por el sistema de visiÃ³n artificial. El backend de Python (`water-meter-detection/backend_python/src/main.py`) procesa la imagen del medidor con YOLO, extrae los dÃ­gitos y envÃ­a la lectura aquÃ­.

**Sin autenticaciÃ³n requerida** - DiseÃ±ado para IoT/IA

**Request Body:**
```json
{
  "meter_id": "MTR001",
  "accumulated_value": 1234.56,
  "timestamp": "2024-12-09T10:30:00Z"  // Opcional, usa fecha actual si se omite
}
```

**Response (201 Created):**
```json
{
  "success": true,
  "reading_id": 123,
  "meter_id": "MTR001",
  "accumulated_value": 1234.56,
  "timestamp": "2024-12-09T10:30:00Z"
}
```

**ğŸ”„ Flujo completo de integraciÃ³n:**
```
1. ESP32 CAM / Web captura imagen del medidor
   â†“
2. Backend Python (FastAPI) recibe imagen en /upload o /test-web
   â†“
3. YOLO procesa imagen y detecta dÃ­gitos (process_image_yolo)
   â†“
4. DÃ­gitos se ordenan por posiciÃ³n X y se construye lectura
   â†“
5. save_reading() hace POST a /api/public/reading/
   â†“
6. Django (water_monitoring) almacena en PostgreSQL
   â†“
7. CÃ¡lculo automÃ¡tico de consumo vs lectura anterior
   â†“
8. Dashboard actualiza mapa y grÃ¡ficas en tiempo real
```

#### **POST** `/api/public/readings/bulk/` 
**Registro masivo de lecturas**

Para enviar mÃºltiples lecturas en una sola peticiÃ³n (Ãºtil para procesamiento batch).

**Request Body:**
```json
{
  "readings": [
    {
      "meter_id": "MTR001",
      "accumulated_value": 1234.56,
      "timestamp": "2024-12-09T10:30:00Z"
    },
    {
      "meter_id": "MTR002",
      "accumulated_value": 9876.54,
      "timestamp": "2024-12-09T10:35:00Z"
    }
  ]
}
```

**Response:**
```json
{
  "success": true,
  "created": 2,
  "failed": 0,
  "created_readings": [
    {"index": 0, "reading_id": 123, "meter_id": "MTR001"},
    {"index": 1, "reading_id": 124, "meter_id": "MTR002"}
  ],
  "errors": []
}
```

---

### ğŸ” Endpoints Autenticados (requieren sesiÃ³n Django)

Para llamadas fetch desde el frontend, incluye `credentials: 'same-origin'` para enviar cookies de sesiÃ³n.

#### **Modelos de Contadores**
- **GET** `/api/models/` - Listar todos los modelos (paginado)
- **POST** `/api/models/` - Crear nuevo modelo
- **GET** `/api/models/{id}/` - Detalles de un modelo
- **PUT/PATCH** `/api/models/{id}/` - Actualizar modelo
- **DELETE** `/api/models/{id}/` - Eliminar modelo
- **GET** `/api/models/{id}/meters/` - Contadores de este modelo

#### **Contadores**
- **GET** `/api/meters/` - Listar contadores (paginado)
- **POST** `/api/meters/` - Crear nuevo contador
- **GET** `/api/meters/{id}/` - Detalles de un contador
- **PUT/PATCH** `/api/meters/{id}/` - Actualizar contador
- **DELETE** `/api/meters/{id}/` - Eliminar (soft delete)
- **GET** `/api/meters/geojson/` - Formato GeoJSON para mapas
- **GET** `/api/meters/{id}/readings/?days=30` - Lecturas de un contador
- **GET** `/api/meters/{id}/stats/?days=30` - EstadÃ­sticas de consumo
- **GET** `/api/meters/{id}/consumption_chart/?days=30` - Datos para grÃ¡ficas

#### **Lecturas**
- **GET** `/api/readings/?meter_id=MTR001` - Listar lecturas (filtrable)
- **POST** `/api/readings/` - Crear lectura manualmente
- **GET** `/api/readings/{id}/` - Detalles de una lectura
- **PUT/PATCH** `/api/readings/{id}/` - Actualizar lectura
- **DELETE** `/api/readings/{id}/` - Eliminar lectura

#### **ImportaciÃ³n**
- **POST** `/api/import-csv/` - Importar lecturas desde CSV
  - Content-Type: `multipart/form-data`
  - Campo: `file`
  - Formato: `meter_id,accumulated_value,timestamp`

---

## ğŸ”— Arquitectura del Sistema Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  water-meter-detection                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   ESP32 CAM  â”‚â”€â”€â”€â”€â”€â”€â–¶  Backend Python (FastAPI)   â”‚     â”‚
â”‚  â”‚  Web Upload  â”‚      â”‚  - YOLO Model (best_m.pt)   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  - Digit Detection          â”‚     â”‚
â”‚                        â”‚  - Reading Extraction        â”‚     â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                         POST /api/public/reading/
                         { meter_id, accumulated_value }
                                         â”‚
                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   water_monitoring (Django)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  API REST (Django REST Framework)                  â”‚    â”‚
â”‚  â”‚  - Recibe lecturas desde IA                        â”‚    â”‚
â”‚  â”‚  - Calcula consumo automÃ¡tico                      â”‚    â”‚
â”‚  â”‚  - Almacena en PostgreSQL + PostGIS                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                     â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Dashboard Web                                      â”‚    â”‚
â”‚  â”‚  - Mapa interactivo (Leaflet)                       â”‚    â”‚
â”‚  â”‚  - GrÃ¡ficas de consumo (Chart.js)                   â”‚    â”‚
â”‚  â”‚  - Panel de administraciÃ³n                          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ImportaciÃ³n CSV

Formato esperado:

```csv
meter_id,accumulated_value,timestamp
MTR001,12345.67,2024-01-15 10:30:00
MTR002,98765.43,2024-01-15 10:35:00
```

Puedes importar desde:
1. La pestaÃ±a "Importar Datos" en el panel de administraciÃ³n
2. El endpoint `/api/import-csv/` (requiere autenticaciÃ³n)

---

## ğŸ” ConfiguraciÃ³n de Seguridad (ProducciÃ³n)

Para producciÃ³n, asegÃºrate de:

1. **Cambiar SECRET_KEY** en `.env`
2. **Configurar DEBUG=False**
3. **Ajustar ALLOWED_HOSTS** con tus dominios
4. **Usar contraseÃ±as fuertes** para el admin
5. **Configurar HTTPS**
6. **Habilitar cookies seguras**:
   ```python
   SESSION_COOKIE_SECURE = True
   CSRF_COOKIE_SECURE = True
   ```
7. **Proteger endpoints pÃºblicos**:
   - Implementa rate limiting en `/api/public/reading/`
   - Considera autenticaciÃ³n por API key para el sistema de IA
   - Valida que los `meter_id` existan antes de procesar
   - Monitorea lecturas sospechosas o duplicadas

---

## ğŸ†• Notas Importantes

- **PaginaciÃ³n**: El frontend maneja respuestas paginadas de DRF (usa `data.results`)
- **Logout**: Vista personalizada que acepta GET/POST para evitar errores 405
- **AutenticaciÃ³n**: Las APIs autenticadas usan `SessionAuthentication`
- **Fetch**: Incluye `credentials: 'same-origin'` al llamar endpoints autenticados desde el navegador
- **Consumo**: Se calcula automÃ¡ticamente entre lecturas consecutivas
- **Coordenadas**: Almacenadas en formato PostGIS (SRID 4326)

---

## ğŸ› Troubleshooting

### Error de GDAL

```bash
# Ubuntu/Debian
sudo apt-get install gdal-bin libgdal-dev

# macOS
brew install gdal
```

### Error de PostGIS

```bash
sudo -u postgres psql -d water_monitoring_db -c "CREATE EXTENSION IF NOT EXISTS postgis;"
```

### Error de permisos en PostgreSQL

```bash
sudo -u postgres psql
ALTER USER postgres WITH PASSWORD 'tu_password';
\q
```

### Error 405 en logout

Ya resuelto con vista personalizada. Si prefieres logout estricto por POST, modifica el enlace en `templates/base.html` a un formulario con CSRF.

### Respuestas vacÃ­as en la UI

Si creas endpoints nuevos que devuelven listas, verifica si DRF los pagina automÃ¡ticamente y ajusta el frontend para usar `data.results`.

---

## ğŸ“¦ requirements.txt

```txt
Django>=4.0
djangorestframework>=3.14
python-decouple>=3.7
psycopg2-binary>=2.9
```

---

## ğŸ¤ Contribuir

1. Fork el proyecto
2. Crea una rama (`git checkout -b feature/nueva-funcionalidad`)
3. Commit tus cambios (`git commit -am 'Agrega nueva funcionalidad'`)
4. Push a la rama (`git push origin feature/nueva-funcionalidad`)
5. Abre un Pull Request

---

## ğŸ“„ Licencia

Este proyecto estÃ¡ bajo la Licencia MIT.

---

**Hecho con â¤ï¸ para monitoreo de agua**